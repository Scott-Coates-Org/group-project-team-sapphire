import { createSlice, createAsyncThunk } from "@reduxjs/toolkit";
import { addDoc, getDocs, query, where } from "firebase/firestore";
import { storage, roomsCollection } from "../firebase/client";
import { getDownloadURL, ref, uploadBytes } from "firebase/storage";

export const createRoom = createAsyncThunk(
  "rooms/create",
  async (formData, { rejectWithValue }) => {
    try {
      const roomsRef = ref(storage, "rooms/" + formData.photo.name);

      const { name, capacity, photo } = formData;

      const snapshot = await uploadBytes(roomsRef, photo);
      const photoLink = await getDownloadURL(snapshot.ref);

      return await addDoc(roomsCollection, {
        name,
        capacity,
        photo: photoLink,
      });
    } catch (error) {
      return rejectWithValue(error);
    }
  }
);

export const getRoomList = createAsyncThunk(
  "rooms/getRoomList",
  async (_, { rejectWithValue }) => {
    try {
      
      const rooms = await getDocs(roomsCollection).then(snapshot=>{
        let data = []
        snapshot.forEach(doc=>{
          data.push({...doc.data(), id: doc.id})
        })
        return data
      })
      
    } catch (error) {
      return rejectWithValue(error);
    }
  },
  {
    condition: (_, { getState, extra }) => {
      const { rooms } = getState();
      const fetchStatus = rooms.loading;
      if (fetchStatus === "fulfilled" || fetchStatus === "pending") {
        // Already fetched or in progress, don't need to re-fetch
        return false;
      }
    },
  }
);

const roomsSlice = createSlice({
  name: "rooms",
  initialState: {
    rooms: [],
    loading: "idle",
  },
  extraReducers: {
    [createRoom.pending]: (state, action) => {
      state.loading = "pending";
    },
    [createRoom.fulfilled]: (state, action) => {
      state.loading = "succeeded";
    },
    [createRoom.rejected]: (state, action) => {
      state.loading = "failed";
    },

    [getRoomList.pending]: (state, action) => {
      state.loading = "pending";
    },
    [getRoomList.fulfilled]: (state, action) => {
      state.loading = "succeeded";
      state.rooms = ["roomzzz"];
    },
    [getRoomList.rejected]: (state, action) => {
      state.loading = "failed";
      console.log(action.error);
    },
  },
});

export default roomsSlice.reducer;

// // Add a new document in collection "demoUsers"
// const _createTestUser = async (user) => {
//   // setDoc gives you control of documents id, if you want autogenerated id's see addDoc https://firebase.google.com/docs/firestore/manage-data/add-data#web-version-9
//   await setDoc(doc(db, 'demoUsers', String(user.id)), user)
//   console.log('Document written with ID: ', user.id)
// }
